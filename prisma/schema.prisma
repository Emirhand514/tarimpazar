// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // Uses a direct connection
}

// Kullanıcı Modeli
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?   // Harici auth (OAuth) kullanılırsa boş olabilir
  image         String?
  role          String    @default("FARMER") // FARMER, WORKER, ENGINEER, BUSINESS, ADMIN
  
  // Profil Bilgileri
  phone         String?
  city          String?
  district      String?
  bio           String?
  certificates  String?   // Virgülle ayrılmış string veya JSON olabilir
  crops         String?   // Yetiştirdiği ürünler (Örn: "Buğday, Mısır")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // İlişkiler
  jobPostings   JobPosting[]
  products      Product[]
  messagesSent  Message[] @relation("SentMessages")
  messagesReceived Message[] @relation("ReceivedMessages")
  conversationsAsP1 Conversation[] @relation("ConversationParticipant1")
  conversationsAsP2 Conversation[] @relation("ConversationParticipant2")
}

// İş İlanları (İstihdam Modülü)
model JobPosting {
  id          String    @id @default(cuid())
  title       String
  description String
  location    String    // İl/İlçe
  wage        Decimal   // Ücret
  currency    String    @default("TRY")
  workType    String    // Tam zamanlı, Mevsimlik vb.
  active      Boolean   @default(true)
  images      String?   // Virgülle ayrılmış URL listesi
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // İlişkiler
  userId      String
  user        User      @relation(fields: [userId], references: [id])
}

// Ürün İlanları (Market Modülü)
model Product {
  id          String    @id @default(cuid())
  title       String
  description String
  price       Decimal
  currency    String    @default("TRY")
  category    String    // Tohum, Gübre, Traktör vb.
  image       String?   // Ana görsel (Thumbnail)
  images      String?   // Galeri görselleri (Virgülle ayrılmış URL listesi)
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // İlişkiler
  userId      String
  user        User      @relation(fields: [userId], references: [id])
}

// Mesajlaşma Modülleri
model Conversation {
  id              String    @id @default(cuid())
  participant1Id  String
  participant1    User      @relation("ConversationParticipant1", fields: [participant1Id], references: [id])
  participant2Id  String
  participant2    User      @relation("ConversationParticipant2", fields: [participant2Id], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  messages        Message[] @relation("ConversationMessages")

  @@unique([participant1Id, participant2Id]) // İki kişi arasında tek sohbet
}

model Message {
  id              String       @id @default(cuid())
  content         String
  isRead          Boolean      @default(false)
  createdAt       DateTime     @default(now())

  senderId        String
  sender          User         @relation("SentMessages", fields: [senderId], references: [id])
  
  receiverId      String?      // Direkt mesaja gerek yok, Conversation üzerinden
  receiver        User?        @relation("ReceivedMessages", fields: [receiverId], references: [id]) // Yine de tutabiliriz ama Conversation daha merkezi

  conversationId  String
  conversation    Conversation @relation("ConversationMessages", fields: [conversationId], references: [id])
}
